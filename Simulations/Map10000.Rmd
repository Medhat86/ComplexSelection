---
title: "Do Mapping on 10000-QTL Complex Selection Simulations"
author: "Timothy M. Beissinger"
date: "February 14, 2018"
output: html_document
---

### Summary
We simulated a trait controlled by **1000** QTL 100 times. For each, one population was selected for an increase in the trait and one population was not selected at all (drift only). Selection or drift persisted for 20 generations. 

### Set preliminary values and load Fst function
These values will store results of loop.

```{r}
#directory = "/home/beissinger/Documents/ComplexSelection/MapSims/Ten" #this is for running locally
directory = "/home/beissingert/data/PolySelect_bigsims/QTL_10000_big/r_qtl_10000" #this is for running on ircf
source("http://beissingerlab.org/docs/vectorFst.R")
results <- matrix(NA,nrow=100000,ncol=102)
results <- data.frame(results)
names(results)<-c("Chr","Pos",paste("sim",1:100,sep=""))
results$Chr <- c(rep(1,10000),rep(2,10000),rep(3,10000),rep(4,10000),rep(5,10000),rep(6,10000),rep(7,10000),rep(8,10000),rep(9,10000),rep(10,10000))
results$Pos <- rep(round(seq(0.00001,100,length.out=10000),5),10)
fullMap <- results[,1:2]
```

### Start the drift loop to calculate all Fst values across drift simulations. 
These will be used to set critical values

```{r}
### start loop
for(sim in 1:100){
print(sim)
iter <- sprintf("%03i",sim)
# load map and allele frequencies
map <- read.table(paste(directory, "/lm_mrk_",iter,".txt",sep=""),header=T,fill=T,stringsAsFactors=F)
freqs <- read.table(paste(directory, "/DriftPop_freq_mrk_",iter,".txt",sep=""),header=T,fill=T,stringsAsFactors=F)

nMarkers <- nrow(map)

freqs0 <- freqs[1:nMarkers,]
freqs20 <- freqs[{4*nMarkers +1}:nrow(freqs),]


### Calculate allele frequencies
#Gen 0
names(freqs0)[4]<- "Allele1"
names(freqs0)[5]<- "Allele2"
freqs0$Allele2[which(substr(freqs0$Allele1,1,1)==2)] <- "2:1.00000" # put this in the spot for the second allele
freqs0$Allele1[which(substr(freqs0$Allele1,1,1)==2)] <- "1:0.00000" 
freqs0$Allele2[which(substr(freqs0$Allele1,3,3)==1)] <- "2:0.00000" ##
freqs0$Allele1 <- as.numeric(substr(freqs0$Allele1,3,1000))
freqs0$Allele2 <- as.numeric(substr(freqs0$Allele2,3,1000))

#Gen 20
names(freqs20)[4]<- "Allele1"
names(freqs20)[5]<- "Allele2"
freqs20$Allele2[which(substr(freqs20$Allele1,1,1)==2)] <- "2:1.00000" # put this in the spot for the second allele
freqs20$Allele1[which(substr(freqs20$Allele1,1,1)==2)] <- "1:0.00000" 
freqs20$Allele2[which(substr(freqs20$Allele1,3,3)==1)] <- "2:0.00000"  ##
freqs20$Allele1 <- as.numeric(substr(freqs20$Allele1,3,1000))
freqs20$Allele2 <- as.numeric(substr(freqs20$Allele2,3,1000))

### Calculate Fst

Fst <-vectorFst(freqs0$Allele1,freqs20$Allele1)
Fst[which(is.nan(Fst))] <- 0 # NaN's were fixed in generation 0.

tmp <- cbind(map,Fst)
merged <- merge(fullMap,by.x=c("Chr","Pos"),tmp,by.y=c("Chr","Position"),all.x=T,all.y=F)
results[,sim+2] <- merged$Fst
}
```

### Determine signficance threshold
To specify a 5% experiment-wide false positive rate, we will identify the highest drifted Fst value in each simulation and then calculate the 95th quantile of this value.

```{r}
maxes <- apply(results[,3:102],2,max,na.rm=T)
threshold <- quantile(maxes,0.95)
print(threshold)
```

### Do mapping with real data, determine true positive rate.
First, create storage vector and vector of true positions.

```{r}
positions <- c(1e-04, 0.100110001, 0.200120002, 0.300130003, 0.400140004, 0.500150005, 0.600160006, 0.700170007, 0.800180008, 0.900190009, 1.00020001, 1.10021001, 1.20022001, 1.30023001, 1.40024001, 1.50025002, 1.60026002, 1.70027002, 1.80028002, 1.90029002, 2.00030002, 2.10031002, 2.20032002, 2.30033002, 2.40034002, 2.50035003, 2.60036003, 2.70037003, 2.80038003, 2.90039003, 3.00040003, 3.10041003, 3.20042003, 3.30043003, 3.40044003, 3.50045004, 3.60046004, 3.70047004, 3.80048004, 3.90049004, 4.00050004, 4.10051004, 4.20052004, 4.30053004, 4.40054004, 4.50055005, 4.60056005, 4.70057005, 4.80058005, 4.90059005, 5.00060005, 5.10061005, 5.20062005, 5.30063005, 5.40064005, 5.50065006, 5.60066006, 5.70067006, 5.80068006, 5.90069006, 6.00070006, 6.10071006, 6.20072006, 6.30073006, 6.40074006, 6.50075007, 6.60076007, 6.70077007, 6.80078007, 6.90079007, 7.00080007, 7.10081007, 7.20082007, 7.30083007, 7.40084007, 7.50085008, 7.60086008, 7.70087008, 7.80088008, 7.90089008, 8.00090008, 8.10091008, 8.20092008, 8.30093008, 8.40094008, 8.50095009, 8.60096009, 8.70097009, 8.80098009, 8.90099009, 9.00100009, 9.10101009, 9.20102009, 9.30103009, 9.40104009, 9.5010501, 9.6010601, 9.7010701, 9.8010801, 9.9010901, 10.0011001, 10.1011101, 10.2011201, 10.3011301, 10.4011401, 10.5011501, 10.6011601, 10.7011701, 10.8011801, 10.9011901, 11.0012001, 11.1012101, 11.2012201, 11.3012301, 11.4012401, 11.5012501, 11.6012601, 11.7012701, 11.8012801, 11.9012901, 12.0013001, 12.1013101, 12.2013201, 12.3013301, 12.4013401, 12.5013501, 12.6013601, 12.7013701, 12.8013801, 12.9013901, 13.0014001, 13.1014101, 13.2014201, 13.3014301, 13.4014401, 13.5014501, 13.6014601, 13.7014701, 13.8014801, 13.9014901, 14.0015001, 14.1015101, 14.2015201, 14.3015301, 14.4015401, 14.5015501, 14.6015601, 14.7015701, 14.8015801, 14.9015901, 15.0016002, 15.1016102, 15.2016202, 15.3016302, 15.4016402, 15.5016502, 15.6016602, 15.7016702, 15.8016802, 15.9016902, 16.0017002, 16.1017102, 16.2017202, 16.3017302, 16.4017402, 16.5017502, 16.6017602, 16.7017702, 16.8017802, 16.9017902, 17.0018002, 17.1018102, 17.2018202, 17.3018302, 17.4018402, 17.5018502, 17.6018602, 17.7018702, 17.8018802, 17.9018902, 18.0019002, 18.1019102, 18.2019202, 18.3019302, 18.4019402, 18.5019502, 18.6019602, 18.7019702, 18.8019802, 18.9019902, 19.0020002, 19.1020102, 19.2020202, 19.3020302, 19.4020402, 19.5020502, 19.6020602, 19.7020702, 19.8020802, 19.9020902, 20.0021002, 20.1021102, 20.2021202, 20.3021302, 20.4021402, 20.5021502, 20.6021602, 20.7021702, 20.8021802, 20.9021902, 21.0022002, 21.1022102, 21.2022202, 21.3022302, 21.4022402, 21.5022502, 21.6022602, 21.7022702, 21.8022802, 21.9022902, 22.0023002, 22.1023102, 22.2023202, 22.3023302, 22.4023402, 22.5023502, 22.6023602, 22.7023702, 22.8023802, 22.9023902, 23.0024002, 23.1024102, 23.2024202, 23.3024302, 23.4024402, 23.5024502, 23.6024602, 23.7024702, 23.8024802, 23.9024902, 24.0025002, 24.1025102, 24.2025202, 24.3025302, 24.4025402, 24.5025502, 24.6025602, 24.7025702, 24.8025802, 24.9025902, 25.0026003, 25.1026103, 25.2026203, 25.3026303, 25.4026403, 25.5026503, 25.6026603, 25.7026703, 25.8026803, 25.9026903, 26.0027003, 26.1027103, 26.2027203, 26.3027303, 26.4027403, 26.5027503, 26.6027603, 26.7027703, 26.8027803, 26.9027903, 27.0028003, 27.1028103, 27.2028203, 27.3028303, 27.4028403, 27.5028503, 27.6028603, 27.7028703, 27.8028803, 27.9028903, 28.0029003, 28.1029103, 28.2029203, 28.3029303, 28.4029403, 28.5029503, 28.6029603, 28.7029703, 28.8029803, 28.9029903, 29.0030003, 29.1030103, 29.2030203, 29.3030303, 29.4030403, 29.5030503, 29.6030603, 29.7030703, 29.8030803, 29.9030903, 30.0031003, 30.1031103, 30.2031203, 30.3031303, 30.4031403, 30.5031503, 30.6031603, 30.7031703, 30.8031803, 30.9031903, 31.0032003, 31.1032103, 31.2032203, 31.3032303, 31.4032403, 31.5032503, 31.6032603, 31.7032703, 31.8032803, 31.9032903, 32.0033003, 32.1033103, 32.2033203, 32.3033303, 32.4033403, 32.5033503, 32.6033603, 32.7033703, 32.8033803, 32.9033903, 33.0034003, 33.1034103, 33.2034203, 33.3034303, 33.4034403, 33.5034503, 33.6034603, 33.7034703, 33.8034803, 33.9034903, 34.0035003, 34.1035103, 34.2035203, 34.3035303, 34.4035403, 34.5035503, 34.6035603, 34.7035703, 34.8035803, 34.9035903, 35.0036004, 35.1036104, 35.2036204, 35.3036304, 35.4036404, 35.5036504, 35.6036604, 35.7036704, 35.8036804, 35.9036904, 36.0037004, 36.1037104, 36.2037204, 36.3037304, 36.4037404, 36.5037504, 36.6037604, 36.7037704, 36.8037804, 36.9037904, 37.0038004, 37.1038104, 37.2038204, 37.3038304, 37.4038404, 37.5038504, 37.6038604, 37.7038704, 37.8038804, 37.9038904, 38.0039004, 38.1039104, 38.2039204, 38.3039304, 38.4039404, 38.5039504, 38.6039604, 38.7039704, 38.8039804, 38.9039904, 39.0040004, 39.1040104, 39.2040204, 39.3040304, 39.4040404, 39.5040504, 39.6040604, 39.7040704, 39.8040804, 39.9040904, 40.0041004, 40.1041104, 40.2041204, 40.3041304, 40.4041404, 40.5041504, 40.6041604, 40.7041704, 40.8041804, 40.9041904, 41.0042004, 41.1042104, 41.2042204, 41.3042304, 41.4042404, 41.5042504, 41.6042604, 41.7042704, 41.8042804, 41.9042904, 42.0043004, 42.1043104, 42.2043204, 42.3043304, 42.4043404, 42.5043504, 42.6043604, 42.7043704, 42.8043804, 42.9043904, 43.0044004, 43.1044104, 43.2044204, 43.3044304, 43.4044404, 43.5044504, 43.6044604, 43.7044704, 43.8044804, 43.9044904, 44.0045004, 44.1045104, 44.2045204, 44.3045304, 44.4045404, 44.5045504, 44.6045604, 44.7045704, 44.8045804, 44.9045904, 45.0046005, 45.1046105, 45.2046205, 45.3046305, 45.4046405, 45.5046505, 45.6046605, 45.7046705, 45.8046805, 45.9046905, 46.0047005, 46.1047105, 46.2047205, 46.3047305, 46.4047405, 46.5047505, 46.6047605, 46.7047705, 46.8047805, 46.9047905, 47.0048005, 47.1048105, 47.2048205, 47.3048305, 47.4048405, 47.5048505, 47.6048605, 47.7048705, 47.8048805, 47.9048905, 48.0049005, 48.1049105, 48.2049205, 48.3049305, 48.4049405, 48.5049505, 48.6049605, 48.7049705, 48.8049805, 48.9049905, 49.0050005, 49.1050105, 49.2050205, 49.3050305, 49.4050405, 49.5050505, 49.6050605, 49.7050705, 49.8050805, 49.9050905, 50.0051005, 50.1051105, 50.2051205, 50.3051305, 50.4051405, 50.5051505, 50.6051605, 50.7051705, 50.8051805, 50.9051905, 51.0052005, 51.1052105, 51.2052205, 51.3052305, 51.4052405, 51.5052505, 51.6052605, 51.7052705, 51.8052805, 51.9052905, 52.0053005, 52.1053105, 52.2053205, 52.3053305, 52.4053405, 52.5053505, 52.6053605, 52.7053705, 52.8053805, 52.9053905, 53.0054005, 53.1054105, 53.2054205, 53.3054305, 53.4054405, 53.5054505, 53.6054605, 53.7054705, 53.8054805, 53.9054905, 54.0055005, 54.1055105, 54.2055205, 54.3055305, 54.4055405, 54.5055505, 54.6055605, 54.7055705, 54.8055805, 54.9055905, 55.0056006, 55.1056106, 55.2056206, 55.3056306, 55.4056406, 55.5056506, 55.6056606, 55.7056706, 55.8056806, 55.9056906, 56.0057006, 56.1057106, 56.2057206, 56.3057306, 56.4057406, 56.5057506, 56.6057606, 56.7057706, 56.8057806, 56.9057906, 57.0058006, 57.1058106, 57.2058206, 57.3058306, 57.4058406, 57.5058506, 57.6058606, 57.7058706, 57.8058806, 57.9058906, 58.0059006, 58.1059106, 58.2059206, 58.3059306, 58.4059406, 58.5059506, 58.6059606, 58.7059706, 58.8059806, 58.9059906, 59.0060006, 59.1060106, 59.2060206, 59.3060306, 59.4060406, 59.5060506, 59.6060606, 59.7060706, 59.8060806, 59.9060906, 60.0061006, 60.1061106, 60.2061206, 60.3061306, 60.4061406, 60.5061506, 60.6061606, 60.7061706, 60.8061806, 60.9061906, 61.0062006, 61.1062106, 61.2062206, 61.3062306, 61.4062406, 61.5062506, 61.6062606, 61.7062706, 61.8062806, 61.9062906, 62.0063006, 62.1063106, 62.2063206, 62.3063306, 62.4063406, 62.5063506, 62.6063606, 62.7063706, 62.8063806, 62.9063906, 63.0064006, 63.1064106, 63.2064206, 63.3064306, 63.4064406, 63.5064506, 63.6064606, 63.7064706, 63.8064806, 63.9064906, 64.0065006, 64.1065106, 64.2065206, 64.3065306, 64.4065406, 64.5065506, 64.6065606, 64.7065706, 64.8065806, 64.9065906, 65.0066007, 65.1066107, 65.2066207, 65.3066307, 65.4066407, 65.5066507, 65.6066607, 65.7066707, 65.8066807, 65.9066907, 66.0067007, 66.1067107, 66.2067207, 66.3067307, 66.4067407, 66.5067507, 66.6067607, 66.7067707, 66.8067807, 66.9067907, 67.0068007, 67.1068107, 67.2068207, 67.3068307, 67.4068407, 67.5068507, 67.6068607, 67.7068707, 67.8068807, 67.9068907, 68.0069007, 68.1069107, 68.2069207, 68.3069307, 68.4069407, 68.5069507, 68.6069607, 68.7069707, 68.8069807, 68.9069907, 69.0070007, 69.1070107, 69.2070207, 69.3070307, 69.4070407, 69.5070507, 69.6070607, 69.7070707, 69.8070807, 69.9070907, 70.0071007, 70.1071107, 70.2071207, 70.3071307, 70.4071407, 70.5071507, 70.6071607, 70.7071707, 70.8071807, 70.9071907, 71.0072007, 71.1072107, 71.2072207, 71.3072307, 71.4072407, 71.5072507, 71.6072607, 71.7072707, 71.8072807, 71.9072907, 72.0073007, 72.1073107, 72.2073207, 72.3073307, 72.4073407, 72.5073507, 72.6073607, 72.7073707, 72.8073807, 72.9073907, 73.0074007, 73.1074107, 73.2074207, 73.3074307, 73.4074407, 73.5074507, 73.6074607, 73.7074707, 73.8074807, 73.9074907, 74.0075007, 74.1075107, 74.2075207, 74.3075307, 74.4075407, 74.5075507, 74.6075607, 74.7075707, 74.8075807, 74.9075907, 75.0076008, 75.1076108, 75.2076208, 75.3076308, 75.4076408, 75.5076508, 75.6076608, 75.7076708, 75.8076808, 75.9076908, 76.0077008, 76.1077108, 76.2077208, 76.3077308, 76.4077408, 76.5077508, 76.6077608, 76.7077708, 76.8077808, 76.9077908, 77.0078008, 77.1078108, 77.2078208, 77.3078308, 77.4078408, 77.5078508, 77.6078608, 77.7078708, 77.8078808, 77.9078908, 78.0079008, 78.1079108, 78.2079208, 78.3079308, 78.4079408, 78.5079508, 78.6079608, 78.7079708, 78.8079808, 78.9079908, 79.0080008, 79.1080108, 79.2080208, 79.3080308, 79.4080408, 79.5080508, 79.6080608, 79.7080708, 79.8080808, 79.9080908, 80.0081008, 80.1081108, 80.2081208, 80.3081308, 80.4081408, 80.5081508, 80.6081608, 80.7081708, 80.8081808, 80.9081908, 81.0082008, 81.1082108, 81.2082208, 81.3082308, 81.4082408, 81.5082508, 81.6082608, 81.7082708, 81.8082808, 81.9082908, 82.0083008, 82.1083108, 82.2083208, 82.3083308, 82.4083408, 82.5083508, 82.6083608, 82.7083708, 82.8083808, 82.9083908, 83.0084008, 83.1084108, 83.2084208, 83.3084308, 83.4084408, 83.5084508, 83.6084608, 83.7084708, 83.8084808, 83.9084908, 84.0085008, 84.1085108, 84.2085208, 84.3085308, 84.4085408, 84.5085508, 84.6085608, 84.7085708, 84.8085808, 84.9085908, 85.0086009, 85.1086109, 85.2086209, 85.3086309, 85.4086409, 85.5086509, 85.6086609, 85.7086709, 85.8086809, 85.9086909, 86.0087009, 86.1087109, 86.2087209, 86.3087309, 86.4087409, 86.5087509, 86.6087609, 86.7087709, 86.8087809, 86.9087909, 87.0088009, 87.1088109, 87.2088209, 87.3088309, 87.4088409, 87.5088509, 87.6088609, 87.7088709, 87.8088809, 87.9088909, 88.0089009, 88.1089109, 88.2089209, 88.3089309, 88.4089409, 88.5089509, 88.6089609, 88.7089709, 88.8089809, 88.9089909, 89.0090009, 89.1090109, 89.2090209, 89.3090309, 89.4090409, 89.5090509, 89.6090609, 89.7090709, 89.8090809, 89.9090909, 90.0091009, 90.1091109, 90.2091209, 90.3091309, 90.4091409, 90.5091509, 90.6091609, 90.7091709, 90.8091809, 90.9091909, 91.0092009, 91.1092109, 91.2092209, 91.3092309, 91.4092409, 91.5092509, 91.6092609, 91.7092709, 91.8092809, 91.9092909, 92.0093009, 92.1093109, 92.2093209, 92.3093309, 92.4093409, 92.5093509, 92.6093609, 92.7093709, 92.8093809, 92.9093909, 93.0094009, 93.1094109, 93.2094209, 93.3094309, 93.4094409, 93.5094509, 93.6094609, 93.7094709, 93.8094809, 93.9094909, 94.0095009, 94.1095109, 94.2095209, 94.3095309, 94.4095409, 94.5095509, 94.6095609, 94.7095709, 94.8095809, 94.9095909, 95.009601, 95.109611, 95.209621, 95.309631, 95.409641, 95.509651, 95.609661, 95.709671, 95.809681, 95.909691, 96.009701, 96.109711, 96.209721, 96.309731, 96.409741, 96.509751, 96.609761, 96.709771, 96.809781, 96.909791, 97.009801, 97.109811, 97.209821, 97.309831, 97.409841, 97.509851, 97.609861, 97.709871, 97.809881, 97.909891, 98.009901, 98.109911, 98.209921, 98.309931, 98.409941, 98.509951, 98.609961, 98.709971, 98.809981, 98.909991, 99.010001, 99.110011, 99.210021, 99.310031, 99.410041, 99.510051, 99.610061, 99.710071, 99.810081, 99.910091)*100 + c(rep(0,1000),rep(10000,1000),rep(20000,1000),rep(30000,1000),rep(40000,1000),rep(50000,1000),rep(60000,1000),rep(70000,1000),rep(80000,1000),rep(90000,1000))
positions <- round(positions,0)
tp <- c() # true positive vector
fp <- c() # false positive vector
```

```{r}

### start loop
for(sim in 1:100){
iter <- sprintf("%03i",sim)
# load map and allele frequencies
map <- read.table(paste(directory, "/lm_mrk_",iter,".txt",sep=""),header=T,fill=T,stringsAsFactors=F)
freqs <- read.table(paste(directory, "/SelectPop_freq_mrk_",iter,".txt",sep=""),header=T,fill=T,stringsAsFactors=F)

nMarkers <- nrow(map)

freqs0 <- freqs[1:nMarkers,]
freqs20 <- freqs[{4*nMarkers +1}:nrow(freqs),]


### Calculate allele frequencies
#Gen 0
names(freqs0)[4]<- "Allele1"
names(freqs0)[5]<- "Allele2"
freqs0$Allele2[which(substr(freqs0$Allele1,1,1)==2)] <- "2:1.00000" # put this in the spot for the second allele
freqs0$Allele1[which(substr(freqs0$Allele1,1,1)==2)] <- "1:0.00000" 
freqs0$Allele2[which(substr(freqs0$Allele1,3,3)==1)] <- "2:0.00000" ##
freqs0$Allele1 <- as.numeric(substr(freqs0$Allele1,3,1000))
freqs0$Allele2 <- as.numeric(substr(freqs0$Allele2,3,1000))

#Gen 20
names(freqs20)[4]<- "Allele1"
names(freqs20)[5]<- "Allele2"
freqs20$Allele2[which(substr(freqs20$Allele1,1,1)==2)] <- "2:1.00000" # put this in the spot for the second allele
freqs20$Allele1[which(substr(freqs20$Allele1,1,1)==2)] <- "1:0.00000" 
freqs20$Allele2[which(substr(freqs20$Allele1,3,3)==1)] <- "2:0.00000"  ##
freqs20$Allele1 <- as.numeric(substr(freqs20$Allele1,3,1000))
freqs20$Allele2 <- as.numeric(substr(freqs20$Allele2,3,1000))

### Calculate Fst

Fst <-vectorFst(freqs0$Allele1,freqs20$Allele1)
Fst[which(is.nan(Fst))] <- 0 # NaN's were fixed in generation 0.

tmp <- cbind(map,Fst)
merged <- merge(fullMap,by.x=c("Chr","Pos"),tmp,by.y=c("Chr","Position"),all.x=T,all.y=F)
signif <- which(merged$Fst > threshold)

### Determine number of true positives
tp[sim] <- 0
for(i in 1:length(positions)){
   seq <-seq(positions[i]-5,positions[i]+5)
   if (length(intersect(seq,signif) > 1)) tp[sim] <- tp[sim]+1
} 

### Determine number of false positives
all <- c()
for(i in 1:length(positions)) all <- c(all,seq(positions[i]-5,positions[i]+5))
fp[sim] <- length(signif) - length(intersect(all,signif))
}
```

### Plot and print results

```{r}
par(mfrow=c(1,2))
plot(tp/length(positions),ylim=c(0,1),col="darkgreen",pch=19,main="True Positive Detection Rate",ylab="Detection Rate",xlab="Simulation Number")
plot(fp,col="darkred",pch=19,main="False Positives",ylab="Number of False Positives",xlab="Simulation Number")
hist(tp,main="True Positives")
hist(fp,main="False Positives")
mean(tp)
median(tp)
mean(fp)
median(fp)


### Save workspace
save.image("Map10000.RData")
```